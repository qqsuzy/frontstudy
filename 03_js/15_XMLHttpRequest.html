<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <script>
    /*
     **********  parsing 연습 많이 하기 !!!! *************
     -> 공공 데이터포털 활용하기

      동기 통신 (Synchronous)
      1. 요청하고 응답 받을 때까지 새로운 요청을 하지 않는 방식이다.
      2. 개념
          client              server 
            A  →→→→→→→→→→→→→→   A
           ACK ←←←←←←←←←←←←←←   A 성공           ACK : OK
            B  →→→→→→→→→→→→→→   B
           NAK ←←←←←←←←←←←←←←   B 실패           NAK : NOT OK
            B  →→→→→→→→→→→→→→   B
           ACK ←←←←←←←←←←←←←←   B 성공
            C  →→→→→→→→→→→→→→   C
           ...
    */    
    /*
      비동기 통신 (Asynchronous) 
      1. 응답을 기다리지 않고 새로운 요청을 보내는 방식이다.
      2. 개념
          client              server 
            A  →→→→→→→→→→→→→→   A
            B  →→→→→→→→→→→→→→   B
            C  →→→→→→→→→→→→→→   C
           ACK ←←←←←←←←←←←←←←   A 성공           ACK : OK
           NAK ←←←←←←←←←←←←←←   B 실패           NAK : NOT OK
            B  →→→→→→→→→→→→→→   B
           ACK ←←←←←←←←←←←←←←   B 성공
           ...  
    */

  </script>

  <div id="div1">
    <button type="button" id="btn1">요청1</button>
    <div id="contents1"></div>
  </div>

  <script>

    /* JSON 데이터를 가상으로 제공하는 Fake API : https://jsonplaceholder.typicode.com/ , https://thetestrequest.com/ */

    function ex01(){

      /* 비동기 요청 */

      // 0. 비동기 통신을 수행하는 JavaScript 객체 생성
      var xhr = new XMLHttpRequest();

      // 1. 요청 생성(초기화)
      // open(RequestMethod, URL, [Sync/Async])
      // 1) RequestMethod : 요청 메소드 (GET, POST, PUT, DELETE 등)
      // 2) URL           : 요청하는 서버 경로
      // 3) Sync/Async    : 동기(Sync)는 false, 비동기(Async)는 true(디폴트) -> 비동기가 디폴트이므로 일반적으로 생략한다.  
      xhr.open('GET', 'https://jsonplaceholder.typicode.com/photos/1', true);

      // 요청 헤더 값 설정(필요하면 설정한다.) (open 보다 나중에 send 보다 먼저 설정해주어야 한다.)
      // xhr.setRequestHeader(name, value); (헤더이름, 헤더값)

      // 2. 요청 전송 (비동기 통신의 경우 즉시 응답된다.)
      xhr.send();

      // 서버 응답에 따른 이벤트 리스너 호출 (필드 값들을 점검하기 위한 이벤트 리스너)
      xhr.addEventListener('readystatechange', function(){ // readystatechange : XMLHttpRequest 객체의 상태(state)가 변경될 때마다 발생하는 이벤트 
                                                           //                    이벤트 리스너(핸들러)로 상태 변화를 감지하고 이에 대응하는 로직을 수행한다. (function(): 값이 바뀌었을 경우 동작할 익명함수)
              // 1. readyState 속성 (요청 상태를 정수 값으로 저장하는 속성)
              //   1) 0 : 클라이언트 생성(open() 호출 이전), UNSENT 
              //   2) 1 : 요청 생성 (open() 호출), OPENED
              //   3) 2 : 요청 전송 (send() 호출), HEADERS_RECEIVED (요청 헤더 받았음~)
              //   4) 3 : 응답 다운로드 중, LOADING 
              //   5) 4 : 완료, DONE 
              
              if(xhr.readyState !== XMLHttpRequest.DONE) 
                return;  // 이벤트 리스너는 함수로 동작을 멈출 때 return을 준다.

              // 2. status 속성 (응답 HTTP 상태 코드) --- 진짜 데이터 인지? 에러 메시지인지? 확인
              if(xhr.status !== 200) {                     // 정상 응답(200)이 아니면,
                console.log('응답 메시지', xhr.statusText) // 응답 메시지(statusText)를 consol 에 출력한다.
                return;                                    // 실패(정상 응답 X)했으니 더이상 실행할 필요가 없기에 return
              }
        
              // 3. 응답 데이터 형식에 따른 속성
              //  1) 응답 텍스트 : responseText  속성, 텍스트 반환 (문자열) -> JSON도 텍스트로 받는다. (09_builtIn_object 파일 내 'JSON 내장 객체' 참고)
              //                                                            -> JSON 내장 객체를 사용하여 JSON.parse 로 JavaScript 객체로 바꾸어 준다.
              //  2) 응답 XML    : responseXML   속성, XMLDocument 반환     -> XML은 텍스트로 받으면 DOM 처리가 불가능하다.
        
              //  내가 직접 응답 데이터의 Type 을 지정할 때는 속성을 response 로 지정한다. 
              var resData = JSON.parse(xhr.responseText); // 순수 문자열로 받아와서 JSON.parse 사용하여 JavaScript 객체로 변환해준다.
              var result = '<div class="album">';
              result += '<div>앨범아이디: ' + resData.albumId + '</div>';
              result += '<div>아이디: ' + resData.id + '</div>'
              result += '<div>제목: ' + resData.title + '</div>'
              result += '<div><a href ="' + resData.url +'"target="_blank">앨범이미지</a></div>';
              result += '<div><img src="' + resData.thumbnailUrl + '"></div>';
              result += '</div>';
              
              // 4. 응답 데이터 화면에 표시
              document.getElementById('contents1').innerHTML = result;

      }) 
      
    }
    document.getElementById('btn1').addEventListener('click', ex01);


  </script>
  <hr>

  <div id="div2">
    <div>
      <input type="text" id="begin" placeholder="시작NO">
      <input type="text" id="end" placeholder="종료NO">
      <button type="button" id="btn2"> 요청2</button>
    </div>
    <table border="1">
      <thead>
        <tr>
          <td>앨범썸네일</td>
          <td>앨범아이디</td>
          <td>아이디</td>
          <td>앨범제목(클릭하면 앨범이미지 오픈)</td>
        </tr>
      </thead>
      <tbody id="contents2">
      </tbody>
    </table>
  </div>

  <script>

    function ex02() {

      var xhr = new XMLHttpRequest();

        xhr.open('GET', 'https://jsonplaceholder.typicode.com/photos/', true);
        xhr.send();
    
        xhr.addEventListener('readystatechange', function() { // 표준 이벤트 방식
    
          if(xhr.readyState !== XMLHttpRequest.DONE) // XMLHttpRequest.DONE 또는 4 로 작성하여도 된다.
            return;
    
          if(xhr.status !== 200) {
            return;
          }
          var resData = JSON.parse(xhr.responseText);
          var begin = document.getElementById('begin').value || 1;
          var end  = document.getElementById('end').value || 10;
          var result = '';
          for(var i = begin - 1; i < end; i++) {   // 전체 요청 후 출력하고자 하는 부분만 추린다.
                                                   // 실제 입력된 값보다 index 값이 1 작기 때문에 begin - 1하고 end 값은 미만이기에 그대로 작성한다. (-1 필요 없음)
              result += '<tr>';
              result += '<td><img src="' + resData[i].thumbnailUrl + '" width=50px></td>';
              result += '<td>' + resData[i].albumId + '</td>';
              result += '<td>' + resData[i].id + '</td>';
              result += '<td><a href="' + resData[i].url + '" target="_blank">' + resData[i].title + '</a></td>';
              result += '</tr>';

            }
            document.getElementById('contents2').innerHTML = result;
        })
      }
    
      document.getElementById('btn2').addEventListener('click', ex02());   

  </script>

  <hr>

  <div id="div3">
    <button type="button" id="btn3">요청3</button>
    <div id="contents3"></div>
  </div>

  <script>
    function ex03() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://thetestrequest.com/authors/1.xml'); // true 생략
      xhr.send();
      xhr.onreadystatechange = function() { // 고전 이벤트 방식
        
        if(xhr.readyState != XMLHttpRequest.DONE)
          retrun;
        if(xhr.status != 200)
          retrun;
        var resData = xhr.responseXML;
        var result = '<div>';
        result += '<div>id: ' + resData.getElementsByTagName('id')[0].textContent + '</div>';// 가지고 온 것(id) 중 첫번째 것[0]의 내부 텍스트 가져온다.
        result += '<div>id_type:' + resData.getElementsByTagName('id')[0].getAttribute('type') + '</div>'; // id의 type을 가져온다. -> 태그의 속성은 getAttribute 메소드로 가져온다.
        result += '<div>name: ' + resData.getElementsByTagName('name')[0].textContent + '</div>';
        result += '<div><img src="' + resData.getElementsByTagName('avatar')[0].textContent + '"</div>';
        result += '<div>created-at: ' + resData.getElementsByTagName('created-at')[0].textContent + '</div>';
        result += '<div>updated-at: ' + resData.getElementsByTagName('updated-at')[0].textContent + '</div';
        result += '</div>';
        document.getElementById('contents3').innerHTML = result;

      }
    }
    document.getElementById('btn3').onclick = ex03;
  </script>

  <hr>

  <div><button type="button" id="btn4">요청4</button></div>
  <div id="div4">
    <div id="contents4"></div>
  </div>
  <style>
    #div4 {
      width: 1000px;
    }
    #contents4 {
      width: 1000px;
      display: flex;
      flex-wrap: wrap;
    }
    #contents4 > .author {
      width: 300px;
      height: 300px;
      border: 1px solid gray;
      border-radius: 10px;
      cursor: pointer;
    }
    #contents4 > .author:hover {
      background-color: beige;
    }
  </style>

  <script>
    // avatar 크기 150px 로 줄여서 가져오기

    function ex04() {

      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://thetestrequest.com/authors.xml');
      xhr.send();

      xhr.onreadystatechange = function() {
        
        if(xhr.readyState !== XMLHttpRequest.DONE)
          return;
        if(xhr.status !== 200) 
          return;

          // <div class="author">1</div>
        resData = xhr.responseXML;
        var objects = resData.getElementsByTagName('object'); // <object> 를 배열에 저장한다.
        var result = '';

        for(var i = 0; i < objects.length; i++) {
          result += '<div class="author">';
          result += '  <div>id:' + objects[i].getElementsByTagName('id')[0].textContent + '</div>';
          result += '  <div>name:' + objects[i].getElementsByTagName('name')[0].textContent + '</div>';
          result += '  <div>email:' + objects[i].getElementsByTagName('email')[0].textContent + '</div>';
          result += '  <div>created-at:' + objects[i].getElementsByTagName('created-at')[0].textContent + '</div>';
          result += '  <div>updated-at:' + objects[i].getElementsByTagName('updated-at')[0].textContent + '</div>';
          result += '  <div><img src="' + objects[i].getElementsByTagName('avatar')[0].textContent + '" width="150px"></div>';
          result += '</div>';
        }


        // for(var i = 0; i < objects.length; i++) {
        //   result += '<div>';
        //   result += '<div class="author">id: ' + resData.getElementsByTagName('id')[i].textContent + '</div>';
        //   result += '<div class="author">name: ' + resData.getElementsByTagName('name')[i].textContent + '</div>';
        //   result += '<div class="author">created-at: ' + resData.getElementsByTagName('created-at')[i].textContent + '</div>';
        //   result += '<div class="author">updated-at: ' + resData.getElementsByTagName('updated-at')[i].textContent + '</div>';
        //   result += '<div class="author"><img src="' + resData.getElementsByTagName('avatar')[i].textContent + '"width="150px" ></div>';
        //   result += '</div>';

        // }
        document.getElementById('contents4').innerHTML = result;

      }

    }
    document.getElementById('btn4').onclick = ex04;

  </script>

<hr>

  <button id="btn5">공공데이터요청</button>
  <script>
    
    function ex05() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'http://apis.data.go.kr/B552061/AccidentDeath/getRestTrafficAccidentDeath?searchYear=2020&siDo=1100&guGun=1116&type=json&numOfRows=20&pageNo=1&serviceKey=bEQBRPHjt0tZrc7EsL0T8usfsZ1%2BwT%2B5jqamBef%2FErC%2F5ZO6N7nYdRmrwR91bh5d3I1AQeY5qdbJOF6Kv0U1CQ%3D%3D');
      xhr.send();
      xhr.onreadystatechange = function(){
        if(xhr.readyState !== XMLHttpRequest.DONE)
          return;
        if(xhr.status !== 200)
          return;
        var resData = JSON.parse(xhr.responseText);
        console.log(resData);
      }
    }
    document.getElementById('btn5').onclick = ex05;
  </script>
  
  <hr>
  <!-- <div id="div5">
    <div>
      <input type="text" id="begin" placeholder="댓글NO">
      <button type="button" id="btn6">요청</button>
    </div>
    <table border="1">
      <thead>
        <tr>
          <td>게시글아이디</td>
          <td>게시글 제목</td>
          <td>이메일</td>
          <td>댓글</td>
        </tr>
      </thead>
      <tbody id="contents5">
      </tbody>
    </table>
  </div> -->

  <div id="div1">
    <button type="button" id="btn6">요청1</button>
    <div id="contents5"></div>
  </div>

  <script>
    
    function ex06() {

      var xhr = new XMLHttpRequest();

      xhr.open('GET', 'https://jsonplaceholder.typicode.com/photos/1', true);
      xhr.send();

      xhr.addEventListener ('readystatechange', function(){
        if(xhr.readyState !== XMLHttpRequest.DONE) 
                return;  // 이벤트 리스너는 함수로 동작을 멈출 때 return을 준다.

              // 2. status 속성 (응답 HTTP 상태 코드) --- 진짜 데이터 인지? 에러 메시지인지? 확인
              if(xhr.status !== 200) {                     // 정상 응답(200)이 아니면,
                console.log('응답 메시지', xhr.statusText) // 응답 메시지(statusText)를 consol 에 출력한다.
                return;                                    // 실패(정상 응답 X)했으니 더이상 실행할 필요가 없기에 return
              }
        
              // 3. 응답 데이터 형식에 따른 속성
              //  1) 응답 텍스트 : responseText  속성, 텍스트 반환 (문자열) -> JSON도 텍스트로 받는다. (09_builtIn_object 파일 내 'JSON 내장 객체' 참고)
              //                                                            -> JSON 내장 객체를 사용하여 JSON.parse 로 JavaScript 객체로 바꾸어 준다.
              //  2) 응답 XML    : responseXML   속성, XMLDocument 반환     -> XML은 텍스트로 받으면 DOM 처리가 불가능하다.
        
              //  내가 직접 응답 데이터의 Type 을 지정할 때는 속성을 response 로 지정한다. 
              var resData = JSON.parse(xhr.responseText); // 순수 문자열로 받아와서 JSON.parse 사용하여 JavaScript 객체로 변환해준다.
              var result = '<div class="album">';
              result += '<div>앨범아이디: ' + resData.albumId + '</div>';
              result += '<div>아이디: ' + resData.id + '</div>'
              result += '<div>제목: ' + resData.title + '</div>'
              result += '<div><a href ="' + resData.url +'"target="_blank">앨범이미지</a></div>';
              result += '<div><img src="' + resData.thumbnailUrl + '"></div>';
              result += '</div>';
              
              // 4. 응답 데이터 화면에 표시
              document.getElementById('contents5').innerHTML = result;

      }) 
      
    }
    document.getElementById('btn6').addEventListener('click', ex06);

  </script>

</body>
</html>